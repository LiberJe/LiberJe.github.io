<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="JeLewine,jelewine@outlook.com"><title>使用Tesseract来识别验证码——训练 · 逆图</title><meta name="description" content="在当前这个时代做开发是一件十分幸福的事。无论你想做什么，都有各种眼花缭乱的库和框架早早的摆在餐桌上
安装根据自己的平台，选择不同的下载包就行了。mac可以直接brew安装，windows用户则直接百度就行了。我安装的是tesseract3.02。在安装完成后在命令行中可以输入tesseract来测试"><meta name="keywords" content="逆图,纪良运,JeLewine,HTML,CSS,javascript,angular,react,vue"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/duoshuo-disqus.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/head.png" style="width:127px;border-radius:50%"><h3 title=""><a href="/">逆图</a></h3><div class="description"><p>一个外行</p></div></div></div><ul class="social-links"><li><a href="http://github.com/liberje" target="blank"><i class="fa fa-github"></i></a></li><li><a href="http://weibo.com/JeLewine" target="blank"><i class="fa fa-weibo"></i></a></li><li><a href="mailto:jelewine@outlook.com"><i class="fa fa-envelope"></i></a></li></ul><div class="footer"></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/head.png" style="width:32px;height:32px;border-radius:50%"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>使用Tesseract来识别验证码——训练</a></h3></div><div class="post-content"><p><strong>在当前这个时代做开发是一件十分幸福的事。无论你想做什么，都有各种眼花缭乱的库和框架早早的摆在餐桌上</strong></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>根据自己的平台，选择不同的下载包就行了。mac可以直接brew安装，windows用户则直接百度就行了。我安装的是tesseract3.02。在安装完成后在命令行中可以输入tesseract来测试一下<br><img src="/2017/05/11/使用Tesseract来识别验证码——训练/tesseract-test.png" alt="img"><br>如上显示就说明已经成功在本机上安装了。<br>接下来我们来先简单测试一下效果</p>
<p><code>tesseract 1.jpg -psm 7 result</code></p>
<p>然后你就发现…这个识别率太感人了。</p>
<p>之所以会出现这方面的问题，主要有两个原因：</p>
<p>1.背景噪点干扰。一般在生成验证码的时候，同时会在验证码的背景上生成很多无关的图像进行干扰。这个问题可以通过<em>GraphicsMagick</em>来解决。不过这个不是我们今天主要去讨论的。</p>
<p>2.tesseract需要训练。Tesseract中的默认样本对相近字符的识别率还是比较低的。不过方便的是，我们可以通过训练来提高它的正确率。名曰：机器学习。哈哈。</p>
<h1 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h1><p>tesseract训练有一套专门的训练工具<em>jTessBoxEditor</em>。接下来，就是利用它来提高tesseract的正确率。</p>
<p>整个训练的过程大致如下：</p>
<p>安装jTessBoxEditor-&gt;获取训练集-&gt;Merge训练集-&gt;生成BOX文件-&gt;字符矫正-&gt;产生字符特征文件-&gt;产生计算字符集-&gt;定义字体特征文件并聚集字符特征-&gt;生成字符形状正常变化特征文件-&gt;合并训练文件-&gt;调用新的字库进行识别</p>
<p>看上去似乎很麻烦。但其实真正一套流程走下来并不会耗费太多的时间。</p>
<h2 id="安装jTessBoxEditor"><a href="#安装jTessBoxEditor" class="headerlink" title="安装jTessBoxEditor"></a>安装jTessBoxEditor</h2><p><a href="https://sourceforge.net/projects/vietocr/files/jTessBoxEditor/" target="_blank" rel="external">下载地址</a> 在使用前要注意，由于其是由Java开发的，所以要先保证你的环境有Java的运行环境。没问题后解压打开就可以启动了。</p>
<h2 id="获取训练集"><a href="#获取训练集" class="headerlink" title="获取训练集"></a>获取训练集</h2><p>一般来说用画图工具自己作画的文件就可以当作训练样本。不过我们的目的是要对验证码进行训练。所以最好是提前对你要登录的网站的验证码爬虫下载个几百张。<strong>需要注意的是，样本图像文件的格式必须是tif/tiff的格式，否则在merge样本的过程中会报‘couldn’t seek’错误</strong></p>
<h2 id="Merge训练集"><a href="#Merge训练集" class="headerlink" title="Merge训练集"></a>Merge训练集</h2><p>打开jTessBoxEditor，Tools-&gt;Merge TIFF，将样本文件全部选上，并将合并文件保存为num.font.exp0.tif<br>这里我把训练集的后缀全部变成了tif后依然报错。所以我换了一个别的工具去进行合并——TiffToy<br><img src="/2017/05/11/使用Tesseract来识别验证码——训练/tiffToy.png" alt="img"></p>
<h2 id="生成BOX文件"><a href="#生成BOX文件" class="headerlink" title="生成BOX文件"></a>生成BOX文件</h2><p>打开命令行并切换至num.font.exp0.tif所在目录，输入，生成文件名为num.font.exp0.box</p>
<p><code>tesseract num.font.exp0.tif num.font.exp0 batch.nochop makebox</code></p>
<p><strong>语法：tesseract [lang].[fontname].exp[num].tif [lang].[fontname].exp[num] batch.nochop makebox</strong></p>
<p><em>lang为语言名称，fontname为字体名称，num为序号；在tesseract中，一定要注意格式。</em></p>
<h2 id="字符矫正"><a href="#字符矫正" class="headerlink" title="字符矫正"></a>字符矫正</h2><p>打开jTessBoxEditor，BOX Editor -&gt; Open，打开num.font.exp0.tif<br><img src="/2017/05/11/使用Tesseract来识别验证码——训练/jTessBoxEditor.png" alt="img"><br>可以看到截图中用红框标注了四个区域。</p>
<p>在第一个区域中对样本中不正确的char进行修正。</p>
<p>在第二个区域中，可以添加，分割box。因为tesseract在识别的过程中，有时会将四个字符识别成三个，或者三个字符识别成四个。这时就需要对box的数量进行修正。</p>
<p>而区域三就是控制box的大小和位置的。</p>
<p>注意位置四的翻页，一份文件中集成了多个样本。最后不要忘记保存。</p>
<p><strong>有时可能会出现blan page的情况，这是因为系统没有识别出来。跳过这个样本就好了</strong><br><img src="/2017/05/11/使用Tesseract来识别验证码——训练/blank_page.png" alt="img"></p>
<h2 id="产生字符特征文件"><a href="#产生字符特征文件" class="headerlink" title="产生字符特征文件"></a>产生字符特征文件</h2><p><code>tesseract num.font.exp0.tif num.font.exp0 nobatch box.train</code></p>
<h2 id="产生计算字符集"><a href="#产生计算字符集" class="headerlink" title="产生计算字符集"></a>产生计算字符集</h2><p><code>unicharset_extractor num.font.exp0.box</code></p>
<h2 id="定义字体特征文件并聚集字符特征"><a href="#定义字体特征文件并聚集字符特征" class="headerlink" title="定义字体特征文件并聚集字符特征"></a>定义字体特征文件并聚集字符特征</h2><p>在目标文件夹内生成一个名为font_properties的文本文件，内容为</p>
<p><code>font 0 0 0 0 0</code></p>
<p>保存后删除.txt后缀。注意：这里font必须与训练名中”fontname”位置所在名称保持一致。</p>
<p><strong>语法：<fontname> <italic> <bold> <fixed> <serif> <fraktur></fraktur></serif></fixed></bold></italic></fontname></strong></p>
<p><em>fontname为字体名称，italic为斜体，bold为黑体字，fixed为默认字体，serif为衬线字体，fraktur德文黑字体，1和0代表有和无，精细区分时可使用。</em></p>
<p><code>mftraining -F font_properties -U unicharset num.font.exp0.tr</code></p>
<h2 id="生成字符形状正常变化特征文件"><a href="#生成字符形状正常变化特征文件" class="headerlink" title="生成字符形状正常变化特征文件"></a>生成字符形状正常变化特征文件</h2><p><code>cntraining num.font.exp0.tr</code></p>
<h2 id="合并训练文件"><a href="#合并训练文件" class="headerlink" title="合并训练文件"></a>合并训练文件</h2><p>为unicharset,inttemp,normproto,pffmtable,shapetable添加前缀”num.”</p>
<p><code>combine_tessdata font.</code></p>
<h2 id="调用新的字库进行识别"><a href="#调用新的字库进行识别" class="headerlink" title="调用新的字库进行识别"></a>调用新的字库进行识别</h2><p>最后将num.trainddata复制到Tesseract-OCR中tessdata文件夹即可。</p>
<p>如果现在对开始时的识别结果进行对比，会发现识别正确率大大提高了。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-05-11</span><i class="fa fa-comment-o"></i><a href="/2017/05/11/使用Tesseract来识别验证码——训练/#comments">评论</a><i class="fa fa-tag"></i><a href="/tags/技术/" title="技术" class="tag">技术 </a></div></div></div></div><div class="share"><div class="evernote"> <a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a href="http://twitter.com/home?status=,http://jelewine.com/2017/05/11/使用Tesseract来识别验证码——训练/,逆图,使用Tesseract来识别验证码——训练,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2016/04/12/死海效应/" title="死海效应" class="btn">下一篇</a></li></ul></div><a id="comments"></a><div data-thread-key="2017/05/11/使用Tesseract来识别验证码——训练/" data-title="使用Tesseract来识别验证码——训练" data-url="http://jelewine.com/2017/05/11/使用Tesseract来识别验证码——训练/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"jelewine", theme:"none"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
    setTimeout(function(){
        var form = document.forms;
        form[0].setAttribute('id', 'commenthw');
    },1000)
})();

</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script>console.log("百度外卖FE,技术渣.weChat:LiberJe,欢迎骚扰.")</script></body></html>